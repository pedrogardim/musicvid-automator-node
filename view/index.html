<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <script>
      let webSocket = new WebSocket('ws://localhost:8080/');
      let el;

      webSocket.onmessage = (event) => {
        el = document.getElementById('message');
        el.innerHTML = event.data;
        handleMessage(JSON.parse(event.data));
      };

      const send = () => {
        const obj = { type: 'newSong' };
        const arr = ['link', 'title', 'author', 'genre'].forEach((key) => {
          obj[key] = document.getElementById(key).value;
        });
        webSocket.send(JSON.stringify(obj));
      };

      const getInfo = () => {
        const url = document.getElementById('link').value;
        webSocket.send(JSON.stringify({ type: 'getInfo', url }));
      };

      const handleMessage = (message) => {
        const { type, author, title, id, genre, prog } = message;
        if (type === 'songInfo') {
          ['title', 'author', 'genre', 'id'].forEach((key) => {
            document.getElementById(key).value = message[key];
          });
        }
        if (type === 'init') {
          const songId = author + '_' + title;
          const li = document.createElement('li');
          li.className =
            'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = author + ' - ' + title;
          li.id = songId + 'cont';
          const span = document.createElement('span');
          span.className = 'badge bg-primary rounded-pill';
          span.innerHTML = 'Empezando...';
          span.id = songId;
          li.appendChild(span);
          document.getElementById('list-container').appendChild(li);
        }
        if (type === 'downloadStart') {
          const span = document.getElementById(id);
          span.innerHTML = 'Descargando';
        }
        if (type === 'downloadFinish') {
          const span = document.getElementById(id);
          span.innerHTML = 'Descargado ✅';
        }
        if (type === 'videoProgress') {
          const span = document.getElementById(id);
          span.innerHTML = `Generando Video... ${prog > 100 ? 100 : prog}%`;
        }
        if (type === 'videoCompleted') {
          const span = document.getElementById(id);
          span.innerHTML = `Video completo ✅`;
        }
      };
    </script>
  </head>

  <body>
    <nav class="navbar navbar-dark bg-primary">
      <div class="container-fluid">
        <a
          class="navbar-brand"
          href="#"
          >MusaNCM</a
        >
      </div>
    </nav>
    <div class="container-lg p-4">
      <div class="input-group mb-3">
        <input
          type="text"
          class="form-control"
          placeholder="Enlace de YouTube o SoundCloud"
          aria-label="Username"
          aria-describedby="basic-addon1"
          onblur="getInfo()"
          id="link"
        />
      </div>

      <div class="input-group mb-3">
        <input
          type="text"
          class="form-control"
          placeholder="Título"
          aria-label="Título"
          id="title"
        />
        <input
          type="text"
          class="form-control"
          placeholder="Artista"
          aria-label="Artista"
          id="author"
        />
        <input
          type="text"
          class="form-control"
          placeholder="Genero"
          aria-label="Genero"
          id="genre"
        />
        <input
          type="text"
          class="form-control"
          placeholder="ID"
          aria-label="ID"
          id="id"
        />
      </div>
      <button
        type="button"
        class="btn btn-primary"
        onClick="send()"
      >
        Añadir
      </button>
      <span
        id="message"
        class=""
      ></span>
      <ul
        id="list-container"
        class="list-group mt-4"
      >
        <!--  <li
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          A list item
          <span class="badge bg-primary rounded-pill">14</span>
        </li>
        <li
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          A second list item
          <span class="badge bg-primary rounded-pill">2</span>
        </li>
        <li
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          A third list item
          <span class="badge bg-primary rounded-pill">1</span>
        </li> -->
      </ul>
    </div>
  </body>
</html>
